<!doctype html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body v-cloak v-scope class="p-5" @vue:mounted="mounted">
    <div class="row mb-5">
        <div class="col-md-3">
            <input type="text" v-model="query" class="form-control mb-3" placeholder="Search"/>

            <select size="20" class="form-control" @change="selectFrame($event.target.value)">
                <optgroup v-for="(atlas, name) in atlases" :label="name">
                    <option v-for="(frame, frameName) in getFiltered(atlas.frames)" :key="`${name}-${frameName}`"
                            :value="frameName">
                        {{frameName}} - {{frame.tileId}}
                    </option>
                </optgroup>
            </select>
        </div>
        <div class="col-md-9" v-if="selectedFrame">
            <canvas
                    v-effect="onCanvasMounted(selectedFrame)"
                    @vue:mounted="onCanvasMounted"
                    id="sprite"
                    class="bg-light"
            />

            <div>
                <code>{{selectedFrame}}</code></br>
            </div>
        </div>
    </div>

    <script type="module">
      import {createApp} from 'https://unpkg.com/petite-vue?module'
      import ResourceManager from '../../src/ResourceManager.mjs';
      import { RESOURCE_ATLASES } from './src/constants.mjs';
      import { getIdByTile } from './src/helpers/tileId.mjs';

      createApp({
        query: '',
        characters: [],
        selectedSprite: null,
        selectedAnimation: null,
        selectedSlide: 0,
        spriteDrawer: null,
        animationTimer: null,
        isPlaying: false,
        isSwapped: false,
        atlases: [],
        selectedFrame: null,

        getTileId(name) {
          const [setName, number] = name.split('_');
          return getIdByTile([setName, parseInt(number)]);
        },

        getFiltered(frames) {
          const items = Object.entries(frames);
          return Object.fromEntries(
            items
              .map(([name, frame]) => {
                const tileId = this.getTileId(name);
                return [name, {frame, tileId}];
              })
              .filter((arr) => {
                return arr[0].toLowerCase().includes(this.query.toLowerCase()) || (arr[1].tileId || '').toString().includes(this.query);
              })
          );
        },

        async mounted() {
          window.manager = new ResourceManager();

          await window.manager.loadBatch(RESOURCE_ATLASES);
          this.atlases = window.manager.atlases;
        },

        async selectFrame(frameName) {
          this.selectedFrame = window.manager.getByAtlas(frameName);
          this.onCanvasMounted();
        },

        onCanvasMounted() {
          const canvas = document.getElementById('sprite');
          if (canvas && canvas.getContext) {
            const ctx = canvas.getContext('2d');
            const [img, x, y, w, h] = this.selectedFrame;
            ctx.canvas.width = w * 2;
            ctx.canvas.height = h * 2;

            ctx.drawImage(img, x, y, w, h, 0, 0, w * 2, h * 2);
          }
        }
      }).mount();
    </script>
</body>
</html>
